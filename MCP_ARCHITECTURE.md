# Terraria AI 向导 - MCP + ReAct 架构设计

## 架构概览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           玩家提问界面 (C#)                                   │
│  按 H 打开 → 输入问题 → 发送                                               │
└─────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      MCP Agent (Python)                                     │
│  接收问题 + 玩家进度上下文                                                   │
└─────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    ReAct 循环 (最多 5 轮)                                    │
│                                                                              │
│  Round 1: DeepSeek 分析 → 需要 Boss 攻略? → 调用 get_boss_guide            │
│       ↑                                                         │           │
│       └────────── 工具返回结果 ──────────────────────────────────┘           │
│                                                                              │
│  Round 2: DeepSeek 分析 → 需要玩家进度? → 调用 get_player_progress         │
│       ↑                                                         │           │
│       └────────── 工具返回结果 ──────────────────────────────────┘           │
│                                                                              │
│  Round 3: DeepSeek 已有足够信息 → 生成最终答案                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      MCP 工具集                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────────────┐  ┌──────────────────────┐                        │
│  │ query_knowledge_base │  │ get_player_progress  │                        │
│  │ 搜索知识库            │  │ 获取玩家进度          │                        │
│  └──────────────────────┘  └──────────────────────┘                        │
│  ┌──────────────────────┐  ┌──────────────────────┐                        │
│  │ get_boss_guide       │  │ get_npc_info         │                        │
│  │ 获取 Boss 攻略       │  │ 获取 NPC 信息        │                        │
│  └──────────────────────┘  └──────────────────────┘                        │
│  ┌──────────────────────┐                                                  │
│  │ recommend_next_step  │                                                  │
│  │ 推荐下一步           │                                                  │
│  └──────────────────────┘                                                  │
└─────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                       数据源层                                               │
├─────────────────────────────────────────────────────────────────────────────┤
│  wiki_core/ (488KB)       wiki_cleaned/ (209MB)        DeepSeek API        │
│  32个核心文件               16,717个完整文件             云端 AI           │
│  (Boss + NPC)            (本地搜索 <100ms)             (网络调用)         │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 核心流程

### 1. 玩家提问

```
玩家: "我现在该打什么Boss？"
```

### 2. MCP Agent 处理

```python
# 系统提示词
你是 Terraria 专家向导。分析玩家问题，调用 MCP 工具获取信息，给出精准建议。
可用工具: query_knowledge_base, get_player_progress, get_boss_guide, ...
```

### 3. ReAct 循环

#### Round 1: 分析问题
```
DeepSeek → 需要知道玩家进度才能推荐
        → 调用 get_player_progress()
```

#### Round 2: 获取信息
```
工具返回 → {
    "progress_report": "已击败史莱姆王...",
    "downed_bosses": {"克苏鲁之眼": false, ...},
    "npc_count": 6
}
```

#### Round 3: 继续收集
```
DeepSeek → 需要了解克苏鲁之眼攻略
        → 调用 get_boss_guide("克苏鲁之眼")
```

#### Round 4: 最终答案
```
DeepSeek → 已有足够信息
        → 生成回答:
        "根据你的进度（已击败史莱姆王，6个NPC），
         建议挑战克苏鲁之眼。
         准备：银甲/金甲、长平台跑道、生命水晶200+
         召唤：夜间使用可疑眼球..."
```

## MCP 工具定义

### 工具 1: query_knowledge_base
```json
{
    "name": "query_knowledge_base",
    "description": "在 Terraria 知识库中搜索特定主题的信息",
    "parameters": {
        "query": "搜索关键词",
        "category": "boss|npc|item|crafting|biome|mechanics"
    }
}
```

### 工具 2: get_player_progress
```json
{
    "name": "get_player_progress",
    "description": "获取玩家当前游戏进度",
    "parameters": {}
}
```

### 工具 3: get_boss_guide
```json
{
    "name": "get_boss_guide",
    "description": "获取特定 Boss 的详细攻略",
    "parameters": {
        "boss_name": "Boss 名称"
    }
}
```

### 工具 4: get_npc_info
```json
{
    "name": "get_npc_info",
    "description": "获取 NPC 的详细信息",
    "parameters": {
        "npc_name": "NPC 名称"
    }
}
```

### 工具 5: recommend_next_step
```json
{
    "name": "recommend_next_step",
    "description": "根据玩家当前进度推荐下一步目标",
    "parameters": {
        "current_progress": "当前进度描述"
    }
}
```

## 实际调用示例

### 请求
```python
response = client.chat.completions.create(
    model="deepseek-chat",
    messages=[
        {"role": "system", "content": "你是 Terraria 专家向导..."},
        {"role": "user", "content": "我现在该打什么Boss？"}
    ],
    tools=MCP_TOOLS,
    tool_choice="auto"
)
```

### 第一轮响应
```json
{
    "content": "我需要先了解玩家的当前进度",
    "tool_calls": [{
        "id": "call_123",
        "type": "function",
        "function": {
            "name": "get_player_progress",
            "arguments": "{}"
        }
    }]
}
```

### 工具返回
```json
{
    "role": "tool",
    "tool_call_id": "call_123",
    "content": "{\"downed_bosses\": {...}, \"npc_count\": 6}"
}
```

### 第二轮响应 (最终答案)
```json
{
    "content": "根据你的进度（已击败史莱姆王，6个NPC），建议挑战克苏鲁之眼..."
}
```

## 优势

1. **精准** - DeepSeek 主动调用工具获取所需信息
2. **上下文感知** - 基于玩家实际进度给出建议
3. **多轮推理** - ReAct 循环收集足够信息
4. **可扩展** - 容易添加新的 MCP 工具
5. **高效** - 本地知识库 + AI 结合

## 与传统方法对比

| 特性 | 传统方法 | MCP + ReAct |
|------|----------|-------------|
| 信息获取 | 一次性搜索 | 按需多轮查询 |
| 上下文 | 有限 | 完整的进度信息 |
| 推理能力 | 无 | 多轮推理 |
| 回答质量 | 可能答非所问 | 精准个性化 |
| 可解释性 | 黑盒 | 清晰的推理过程 |

## 实现文件

- `mcp_agent.py` - MCP Agent 核心实现
- `knowledge_search.py` - 本地知识库搜索
- `react_bridge.py` - C# 调用桥接
